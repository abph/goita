<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ごいた　一人プレイ</title>
  <style>
    body { font-family: sans-serif; max-width: 1250px; margin: 20px auto; }
    h1 { margin-bottom: 12px; }

    .board-wrap { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }

    .board {
      display: grid;
      grid-template-columns: repeat(10, 58px);
      grid-template-rows: repeat(10, 58px);
      gap: 6px;
      user-select: none;
      margin: 0 auto;
    }

    .cell {
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      position: relative;
    }

    /* 受け・攻めスロット */
    .slot {
      border: 2px solid #999;
      background: #fff;
      font-weight: 600;
    }
    .slot .val {
      font-size: 18px;
      font-weight: 800;
    }

    /* ★ 攻め（attack）マスは薄い青 */
    .slot.attack {
      background: #eef6ff; /* とても薄い青 */
    }

    /* 手札 */
    .hand {
      border: 2px solid #4a90e2;
      background: #ffffff;
    }
    .hand .val {
      font-size: 18px;
      font-weight: 900;
    }

    .hand.clickable { cursor: pointer; }
    .hand.clickable:hover { outline: 3px solid rgba(74,144,226,0.35); }

    /* PASSセル */
    .pass {
      border: 3px solid #e74c3c;
      background: #fff2f2;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: 0.5px;
    }
    .pass:hover { background: #ffe7e7; }
    .pass.disabled { opacity: 0.35; cursor: default; }

    /* 下部UI */
    .ui {
      margin-top: 14px;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }

    .meta {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .btns { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
    button { padding: 7px 10px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button:hover { background: #f6f6f6; }

    .hint { background:#fff7e6; border: 1px solid #ffd39a; padding: 8px; border-radius: 10px; margin: 10px 0; }

    .bottom-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    .card {
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 10px;
      background: #fafafa;
    }

    pre {
      background:#f7f7f7;
      padding:10px;
      border-radius:10px;
      max-height: 420px;
      overflow:auto;
      margin: 0;
    }
  </style>
</head>

<body>
<h1>ごいた 10×10盤面</h1>

<div class="board-wrap">
  <div id="board" class="board"></div>
</div>

<div class="ui">
  <div class="meta">
    <b>game_id</b><span id="gid">-</span>
    <b>turn</b><span id="turn">-</span>
    <b>phase</b><span id="phase">-</span>
    <b>attacker</b><span id="attacker">-</span>
    <b>current_attack</b><span id="current_attack">-</span>
  </div>

  <div class="btns">
    <button onclick="newGame()">新規ゲーム</button>
    <button onclick="refresh()">更新</button>
    <button onclick="toggleAllHands()" id="toggleHandsBtn">みんなの手札を公開</button>
    <span>（PASS：8列目9行目）</span>
  </div>

  <div class="hint" id="handHint">手札をクリックして駒を出します。</div>

  <div class="bottom-grid">
    <div class="card">
      <details>
        <summary><b>（デバッグ用）合法手</b></summary>
        <div id="actions" style="margin-top:8px;"></div>
      </details>
    </div>

    <div class="card">
      <b>ログ</b>
      <pre id="log" style="margin-top:8px;"></pre>
    </div>
  </div>
</div>

<script>
const API = "";
let gid = null;
let showAllHands = false;
let latestState = null;
let latestLegal = [];

function key(c,r){ return `${c},${r}`; }

const PIECE_LABEL = {
  "9":"王","8":"玉","7":"飛","6":"角",
  "5":"金","4":"銀","3":"馬","2":"香","1":"し"
};
const pieceToLabel = v => PIECE_LABEL[v] ?? v;

function sortHandNumeric(a){
  return Array.isArray(a) ? [...a].sort((x,y)=>+x-+y) : a;
}
function setHint(m){ document.getElementById("handHint").textContent=m; }

const SLOTS = {
  A:{receive:[[4,8],[5,8],[6,8],[7,8]], attack:[[4,9],[5,9],[6,9],[7,9]]},
  C:{receive:[[7,3],[6,3],[5,3],[4,3]], attack:[[7,2],[6,2],[5,2],[4,2]]},
  B:{receive:[[8,7],[8,6],[8,5],[8,4]], attack:[[9,7],[9,6],[9,5],[9,4]]},
  D:{receive:[[3,4],[3,5],[3,6],[3,7]], attack:[[2,4],[2,5],[2,6],[2,7]]},
};
const HAND_POS = {
  A:[[2,10],[3,10],[4,10],[5,10],[6,10],[7,10],[8,10],[9,10]],
  C:[[2,1],[3,1],[4,1],[5,1],[6,1],[7,1],[8,1],[9,1]],
  B:[[10,2],[10,3],[10,4],[10,5],[10,6],[10,7],[10,8],[10,9]],
  D:[[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],[1,9]],
};

function buildMap(obj){
  const m=new Map();
  for(const p in obj){
    obj[p].forEach((c,i)=>m.set(key(c[0],c[1]),{p,idx:i}));
  }
  return m;
}
const SLOT_MAP=new Map(
  Object.entries(SLOTS).flatMap(([p,o])=>[
    ...o.receive.map((c,i)=>[key(c[0],c[1]),{p,kind:"R",idx:i}]),
    ...o.attack.map((c,i)=>[key(c[0],c[1]),{p,kind:"A",idx:i}]),
  ])
);
const HAND_MAP=buildMap(HAND_POS);

async function submitAction(a){
  await fetch(`${API}/games/${gid}/step`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:a})
  });
}

async function onPassClick(){
  const pass=latestLegal.find(a=>a.action_type==="pass");
  if(!pass){ setHint("今はパスできません"); return; }
  await submitAction(pass); await refresh();
}

function renderBoard(s){
  const b=document.getElementById("board"); b.innerHTML="";
  for(let r=1;r<=10;r++)for(let c=1;c<=10;c++){
    const d=document.createElement("div");
    d.className="cell"; d.style.gridColumn=c; d.style.gridRow=r;

    if(c===8&&r===9){
      d.classList.add("pass");
      d.textContent="PASS";
      if(s.turn==="A"&&!s.finished&&latestLegal.some(a=>a.action_type==="pass"))
        d.onclick=onPassClick;
      else d.classList.add("disabled");
      b.appendChild(d); continue;
    }

    const k=key(c,r);
    const h=HAND_MAP.get(k);
    if(h){
      d.classList.add("hand");
      const v=document.createElement("div"); v.className="val";
      if(h.p==="A"||showAllHands){
        const arr=sortHandNumeric(s.hands?.[h.p]);
        const card=arr?.[h.idx];
        v.textContent=card?pieceToLabel(card):"□";
        if(h.p==="A"&&s.turn==="A"&&!s.finished&&card)
          d.onclick=()=>onHandPieceClick(card);
      }else v.textContent="□";
      d.appendChild(v); b.appendChild(d); continue;
    }

    const sl=SLOT_MAP.get(k);
    if(sl){
      d.classList.add("slot");
      if(sl.kind==="A") d.classList.add("attack"); /* ★ここ */
      const v=document.createElement("div"); v.className="val";
      const kind=sl.kind==="R"?"receive":"attack";
      const pc=s.board_public?.[sl.p]?.[kind]?.[sl.idx];
      if(pc){
        if(kind==="receive" && s.board_public?.[sl.p]?.receive_hidden?.[sl.idx])
          v.textContent="■";
        else v.textContent=pieceToLabel(pc);
      }
      d.appendChild(v);
    }
    b.appendChild(d);
  }
}

async function fetchLegal(){
  return await (await fetch(`${API}/games/${gid}/legal_actions`)).json();
}

async function newGame(){
  const j=await (await fetch(`${API}/games`,{method:"POST"})).json();
  gid=j.game_id; document.getElementById("gid").textContent=gid;
  await refresh();
}

async function refresh(){
  if(!gid)return;
  const s=await (await fetch(`${API}/games/${gid}/state`)).json();
  latestState=s;
  latestLegal=await fetchLegal();
  document.getElementById("turn").textContent=s.turn;
  document.getElementById("phase").textContent=s.phase;
  document.getElementById("attacker").textContent=s.attacker||"";
  document.getElementById("current_attack").textContent=s.current_attack?pieceToLabel(s.current_attack):"";
  document.getElementById("log").textContent=(s.log||[]).join("\n");
  renderBoard(s);
}
</script>
</body>
</html>
