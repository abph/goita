<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ごいた 10×10盤面</title>
  <style>
    body { font-family: sans-serif; max-width: 1250px; margin: 20px auto; }
    h1 { margin-bottom: 12px; }
    .board-wrap { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    .board {
      display: grid;
      grid-template-columns: repeat(10, 58px);
      grid-template-rows: repeat(10, 58px);
      gap: 6px;
      user-select: none;
      margin: 0 auto;
    }
    .cell {
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      position: relative;
    }

    /* ===== スロット ===== */
    .slot { border: 2px solid #999; background: #fff; font-weight: 600; }
    .slot .val { font-size: 18px; font-weight: 800; }

    .slot.attack { background: #eef6ff; }
    .slot.attack.human { border-color: #4a90e2; background: #eef6ff; }
    .slot.attack.ai    { border-color: #e74c3c; background: #fff2f2; }
    .slot.attack.ai .val { color: #b00000; font-weight: 900; }

    .slot.current-attack {
      background: #cfe8ff;
      border-color: #2b78d6;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(43,120,214,0.6); }
      70%  { box-shadow: 0 0 0 10px rgba(43,120,214,0); }
      100% { box-shadow: 0 0 0 0 rgba(43,120,214,0); }
    }

    /* ===== 手札 ===== */
    .hand { border: 2px solid #4a90e2; background: #ffffff; }
    .hand.human { border-color: #4a90e2; }
    .hand.ai    { border-color: #e74c3c; }

    .hand .val { font-size: 18px; font-weight: 900; }
    .hand.clickable { cursor: pointer; }
    .hand.clickable:hover { outline: 3px solid rgba(74,144,226,0.35); }
    .hand.disabled { background: #f0f0f0; border-color: #bbb; color: #999; cursor: not-allowed; }
    .hand.disabled .val { color: #999; }

    /* ===== PASS ===== */
    .pass {
      border: 3px solid #e74c3c;
      background: #fff2f2;
      cursor: pointer;
      font-weight: 900;
    }
    .pass.disabled { opacity: 0.35; cursor: default; }

    /* ===== 座席ラベル ===== */
    .seat-label{
      border: 2px solid #333;
      background: #fff;
      font-weight: 900;
      font-size: 22px;
    }

    .ui { margin-top: 14px; border: 1px solid #ddd; border-radius: 12px; padding: 12px; background: #fff; }
    .meta { display: grid; grid-template-columns: 140px 1fr; gap: 6px 10px; font-size: 13px; margin-bottom: 10px; }
    .btns { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    button, select { padding: 7px 10px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .hint { background:#fff7e6; border: 1px solid #ffd39a; padding: 8px; border-radius: 10px; margin: 10px 0; }
    .small { font-size: 12px; color: #555; }
    .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
    .card { border: 1px solid #e6e6e6; border-radius: 12px; padding: 10px; background: #fafafa; }
    pre { background:#f7f7f7; padding:10px; border-radius:10px; max-height: 420px; overflow:auto; margin: 0; }
  </style>
</head>
<body>
<h1>ごいた 10×10盤面</h1>

<div class="board-wrap">
  <div id="board" class="board"></div>
</div>

<div class="ui">
  <div class="meta">
    <b>game_id</b><span id="gid">-</span>
    <b>自分の席</b>
    <span>
      <select id="seatSelect">
        <option>A</option><option>B</option><option>C</option><option>D</option>
      </select>
    </span>
    <b>turn</b><span id="turn">-</span>
    <b>phase</b><span id="phase">-</span>
    <b>attacker</b><span id="attacker">-</span>
    <b>current_attack</b><span id="current_attack">-</span>
  </div>

  <div class="btns">
    <button onclick="newGame()">新規ゲーム（main卓リセット）</button>
    <button onclick="refresh()">更新</button>
    <span class="small">（自動更新：3秒）</span>
  </div>

  <div class="hint" id="handHint">手札をクリックして駒を出します。</div>

  <div class="bottom-grid">
    <div class="card">
      <details>
        <summary><b>（デバッグ用）合法手</b></summary>
        <div id="actions"></div>
      </details>
    </div>
    <div class="card">
      <div><b>ログ</b></div>
      <pre id="log"></pre>
    </div>
  </div>
</div>

<script>
const API = "";
const MAIN_GID = "main";
let gid = MAIN_GID;

let mySeat = (localStorage.getItem("goita_mySeat") || "A").toUpperCase();
let lastSeat = mySeat;

let latestState = null;
let latestLegal = [];
let pending = null;
let refreshing = false; // ★二重実行ガード

function seatIsHuman(state, seat){
  const hs = state?.human_seats;
  return Array.isArray(hs) ? hs.includes(seat) : seat === mySeat;
}

async function refresh(){
  if(refreshing) return;
  refreshing = true;
  try{
    const qs = new URLSearchParams({ viewer: mySeat });
    const state = await (await fetch(`${API}/games/${gid}/state?${qs}`)).json();
    latestState = state;

    document.getElementById("gid").textContent = gid;
    document.getElementById("turn").textContent = state.turn;
    document.getElementById("phase").textContent = state.phase;
    document.getElementById("attacker").textContent = state.attacker || "";
    document.getElementById("current_attack").textContent = state.current_attack || "";
    document.getElementById("log").textContent = (state.log||[]).join("\n");

    const res = await fetch(`${API}/games/${gid}/legal_actions?player=${mySeat}`);
    latestLegal = await res.json();

    // 描画（既存ロジックと同じ）
    // ※ ここでは簡略。あなたの renderBoard / renderActions をそのまま使ってOK
    renderBoard(state);
    renderActions();
  } finally {
    refreshing = false;
  }
}

window.addEventListener("load", async ()=>{
  document.getElementById("seatSelect").value = mySeat;
  await fetch(`${API}/games/main/claim?seat=${mySeat}`, {method:"POST"});
  await refresh();
  setInterval(refresh, 3000); // ★3秒更新
});
</script>
</body>
</html>
