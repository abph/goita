<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ごいた盤面 10×10</title>
  <style>
    body { font-family: sans-serif; max-width: 1250px; margin: 20px auto; }
    .row { display: flex; gap: 16px; align-items: flex-start; }
    .panel { width: 380px; border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    .board-wrap { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }

    .board {
      display: grid;
      grid-template-columns: repeat(10, 58px);
      grid-template-rows: repeat(10, 58px);
      gap: 6px;
      user-select: none;
    }
    .cell {
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      position: relative;
    }

    .slot { border: 2px solid #999; background: #fff; font-weight: 600; }
    .slot .val { font-size: 18px; font-weight: 800; }

    .hand { border: 2px solid #4a90e2; background: #ffffff; }
    .hand .val { font-size: 18px; font-weight: 900; }

    button { margin: 4px 4px 4px 0; }
    pre { background:#f7f7f7; padding:10px; border-radius:10px; max-height: 480px; overflow:auto; }
    .meta { font-size: 13px; line-height: 1.5; }
  </style>
</head>
<body>
  <h1>ごいた 10×10盤面</h1>

  <div class="row">
    <div class="board-wrap">
      <div id="board" class="board"></div>
    </div>

    <div class="panel">
      <div class="meta">
        <div><b>game_id:</b> <span id="gid">-</span></div>
        <div><b>turn:</b> <span id="turn">-</span></div>
        <div><b>phase:</b> <span id="phase">-</span></div>
        <div><b>attacker:</b> <span id="attacker">-</span></div>
        <div><b>current_attack:</b> <span id="current_attack">-</span></div>
      </div>

      <hr/>

      <button onclick="newGame()">新規ゲーム</button>
      <button onclick="refresh()">更新</button>
      <button onclick="toggleAllHands()" id="toggleHandsBtn">みんなの手札を公開</button>

      <hr/>

      <div><b>合法手（人間A）</b></div>
      <div id="actions"></div>

      <hr/>
      <div><b>ログ</b></div>
      <pre id="log"></pre>
    </div>
  </div>

<script>
const API = "http://localhost:8000";
let gid = null;
let showAllHands = false;
let lastState = null;

function key(col,row){ return `${col},${row}`; }

// ====== 駒表示変換（数字→漢字） ======
const PIECE_LABEL = {
  "9": "王","8": "玉","7": "飛","6": "角",
  "5": "金","4": "銀","3": "馬","2": "香","1": "し",
};
function pieceToLabel(v){
  if (!v) return "";
  if (v === "■" || v === "□") return v;
  return PIECE_LABEL[v] ?? v;
}

// ====== 受け/攻めスロット（確定版） ======
const SLOTS = {
  A: { receive:[[4,8],[5,8],[6,8],[7,8]], attack:[[4,9],[5,9],[6,9],[7,9]] },
  C: { receive:[[7,3],[6,3],[5,3],[4,3]], attack:[[7,2],[6,2],[5,2],[4,2]] },
  B: { receive:[[8,7],[8,6],[8,5],[8,4]], attack:[[9,7],[9,6],[9,5],[9,4]] },
  D: { receive:[[3,4],[3,5],[3,6],[3,7]], attack:[[2,4],[2,5],[2,6],[2,7]] },
};

// ====== 手札配置 ======
const HAND_POS = {
  A: [[2,10],[3,10],[4,10],[5,10],[6,10],[7,10],[8,10],[9,10]],
  C: [[2,1],[3,1],[4,1],[5,1],[6,1],[7,1],[8,1],[9,1]],
  B: [[10,2],[10,3],[10,4],[10,5],[10,6],[10,7],[10,8],[10,9]],
  D: [[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],[1,9]],
};

function buildSlotMap(){
  const m=new Map();
  for(const p of ["A","B","C","D"]){
    SLOTS[p].receive.forEach((c,i)=>m.set(key(c[0],c[1]),{p,kind:"R",idx:i+1}));
    SLOTS[p].attack.forEach((c,i)=>m.set(key(c[0],c[1]),{p,kind:"A",idx:i+1}));
  }
  return m;
}
const SLOT_MAP = buildSlotMap();

function buildHandMap(){
  const m=new Map();
  for(const p of ["A","B","C","D"]){
    HAND_POS[p].forEach((c,i)=>m.set(key(c[0],c[1]),{p,idx:i}));
  }
  return m;
}
const HAND_MAP = buildHandMap();

// ====== 手札公開トグル ======
function toggleAllHands(){
  showAllHands = !showAllHands;
  document.getElementById("toggleHandsBtn").textContent =
    showAllHands ? "手札表示を戻す" : "みんなの手札を公開";
  refresh();
}

// ====== 盤面描画 ======
function renderBoard(state){
  const board=document.getElementById("board");
  board.innerHTML="";

  for(let row=1;row<=10;row++){
    for(let col=1;col<=10;col++){
      const div=document.createElement("div");
      div.className="cell";
      div.style.gridColumn=col;
      div.style.gridRow=row;

      const k=key(col,row);

      // 手札セル
      const hand=HAND_MAP.get(k);
      if(hand){
        div.classList.add("hand");
        const val=document.createElement("div");
        val.className="val";

        // showAllHands=true のときは /state?reveal_hands=1 により配列が返る
        if(hand.p==="A" || showAllHands){
          const arr = state.hands?.[hand.p];
          const card = Array.isArray(arr) ? arr[hand.idx] : null;
          val.textContent = card ? pieceToLabel(card) : "□";
        }else{
          val.textContent="□";
        }

        div.appendChild(val);
        board.appendChild(div);
        continue;
      }

      // 受け/攻めスロット
      const slot=SLOT_MAP.get(k);
      if(slot){
        div.classList.add("slot");
        const val=document.createElement("div");
        val.className="val";

        const kindKey = slot.kind==="R"?"receive":"attack";
        const piece = state.board_public?.[slot.p]?.[kindKey]?.[slot.idx-1];

        if(piece){
          if(kindKey==="receive"){
            const hidden=state.board_public?.[slot.p]?.receive_hidden?.[slot.idx-1];
            val.textContent = hidden ? "■" : pieceToLabel(piece);
          }else{
            val.textContent = pieceToLabel(piece);
          }
        }
        div.appendChild(val);
      }

      board.appendChild(div);
    }
  }
}

// ====== 合法手描画（復活） ======
async function renderActions(){
  const actionsDiv = document.getElementById("actions");
  actionsDiv.innerHTML = "";
  if (!gid) return;

  const acts = await (await fetch(`${API}/games/${gid}/legal_actions`)).json();
  acts.forEach(a => {
    const t = a.action_type;
    const b = a.block ? pieceToLabel(a.block) : "";
    const at = a.attack ? pieceToLabel(a.attack) : "";
    const label = `${t} ${b} ${at}`.trim();

    const btn = document.createElement("button");
    btn.textContent = label;
    btn.onclick = async () => {
      await fetch(`${API}/games/${gid}/step`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({action: a})
      });
      await refresh();
    };
    actionsDiv.appendChild(btn);
  });
}

// ====== API ======
async function newGame(){
  const r=await fetch(`${API}/games`,{method:"POST"});
  const j=await r.json();
  gid=j.game_id;
  document.getElementById("gid").textContent=gid;
  await refresh();
}

async function refresh(){
  if(!gid) return;

  // showAllHands のときだけ reveal_hands=1
  const url = `${API}/games/${gid}/state` + (showAllHands ? `?reveal_hands=1` : ``);
  const state = await (await fetch(url)).json();
  lastState = state;

  document.getElementById("turn").textContent = state.turn;
  document.getElementById("phase").textContent = state.phase;
  document.getElementById("attacker").textContent = state.attacker;
  document.getElementById("current_attack").textContent =
    state.current_attack ? pieceToLabel(state.current_attack) : "";

  document.getElementById("log").textContent = (state.log||[]).join("\n");

  renderBoard(state);
  await renderActions();
}
</script>
</body>
</html>
